name: Deploy Whale
on: 
  workflow_dispatch:
  push:
jobs:  
  deploy:
    name: Deploy whale
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Stop containers
        run: sudo docker-compose stop
      
      - name: Remove containers
        run: |
          for c in `sudo docker ps -a --format '{{.Names}}'` 
          do
            sudo docker rm -f $c
          done

      - name: Remove config files
        run: sudo rm -rf /srv/*

      - name: Sync files
        run: sudo rsync -av srv/* /srv/ --delete
      
      - name: Set env-file
        run: |
          echo "export MYSQL_ROOT_PASSWORD=${{secrets.MYSQL_ROOT_PASSWORD}}" > .env


      - name: Deploy containers
        run: sudo docker-compose --enf-file .env up -d